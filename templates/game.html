<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>–ö–ø–æ–ø –±—É–Ω–∫–µ—Ä</title>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #111827;
      --panel-2: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --pink: #ec4899;
      --pink-hover: #db2777;
      --green: #10b981;
      --green-dark: #065f46;
      --blue: #3b82f6;
      --blue-hover: #2563eb;
      --red: #ef4444;
      --red-dark: #7f1d1d;
      --border: #374151;
      --shadow: rgba(0,0,0,0.4);
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-columns: 1fr 280px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
    }

    header {
      grid-column: 1 / 3;
      background-color: var(--panel);
      color: var(--text);
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    h3 {
        display: block;
        font-size: 1.17em;
        margin-block-start: 0.4em;
        margin-block-end: 0.4em;
        margin-inline-start: 0px;
        margin-inline-end: 0px;
        font-weight: bold;
        unicode-bidi: isolate;
    }

    .info-btn {
      display: none;
      background: var(--pink);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    .game-info {
      font-size: 0.9em;
      color: var(--muted);
      white-space: nowrap;
    }

    .players-container {
      display: flex;
      gap: 10px;
      padding: 10px 16px;
      overflow-x: auto;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
    }

    .player-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 90px;
      padding: 10px 8px;
      border-radius: 10px;
      background: var(--panel-2);
      color: var(--text);
      cursor: pointer;
      border: 1px solid var(--border);
      transition: transform .15s ease, box-shadow .2s ease;
      scroll-snap-align: start;
      flex: 0 0 auto;
    }

    .player-badge:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px var(--shadow);
    }

    .player-badge.selected {
      box-shadow: 0 0 0 2px var(--pink);
    }

    .player-badge.exit {
      background: var(--red);
      border-color: var(--red-dark);
    }

    .player-badge.admin {
      background: #f9fafb;
      color: #111827;
      border-color: #e5e7eb;
    }
    .player-badge.admin .player-number { color: #111827; }
    .player-badge.admin .player-name { color: #111827; }

    .player-badge.exit .player-number { color: #ffffff; }
    .player-badge.exit .player-name { color: #ffffff; }


    .player-number {
      font-weight: bold;
      font-size: 1.1em;
      color: var(--pink);
    }

    .player-name {
      font-size: 0.9em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      color: var(--text);
    }

    .sidebar {
      grid-column: 2;
      grid-row: 2;
      background: var(--panel);
      color: var(--text);
      padding: 20px;
      overflow-y: auto;
      border-left: 1px solid var(--border);
    }

    .player-card {
      grid-column: 1;
      grid-row: 2;
      padding: 16px;
      overflow-y: auto;
    }

    .field {
      margin-bottom: 15px;
      padding: 12px 14px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 2px 6px var(--shadow);
    }
    .field-row {
      display: flex;        /* –≤ –æ–¥–Ω—É –ª–∏–Ω–∏—é */
      gap: 0.5em;           /* —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–¥–ø–∏—Å—å—é –∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º */
      align-items: baseline;/* —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –±—ã–ª –Ω–∞ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ –ø–æ –±–∞–∑–æ–≤–æ–π –ª–∏–Ω–∏–∏ */
    }

    .field-name {
      font-weight: bold;
      color: var(--pink);
      margin-bottom: 6px;
    }
    .field-value {
      margin-bottom: 6px;
    }

    .field-value {
      min-height: 24px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã—Ö —Å—Ç—Ä–æ–∫ */
    .no-wrap { white-space: nowrap; }
    .inline-row { display: inline-flex; align-items: center; gap: 6px; flex-wrap: nowrap; }

    /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ */
    .skills-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
    }
    .open-skill-btn {
        display:inline-flex;
        align-items:center;
        justify-content:center;
        min-width:40px;
        height:100%;
        padding:6px 8px;
        border-radius:8px;
        font-weight:600;
        margin-left: auto;
        flex-shrink: 0;

    }
    .reveal-btn, .edit-toggle-btn {
        display:inline-flex;
        align-items:center;
        justify-content:center;
        min-width:40px;
        height:36px;
        padding:6px 8px;
        border-radius:8px;
        font-weight:600;
        margin-left: auto;
        flex-shrink: 0;
    }

    .field .field-actions {
        margin-left:auto;
        display:inline-flex;
        align-items:center;
        gap:8px;
        min-width:96px; /* –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        justify-content:flex-end;
    }
    .reveal-btn:hover, .edit-toggle-btn:hover {
        background: var(--pink-hover);
    }

    /* –û—Ç–º–µ—Ç–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π (–∏–Ω–≤–µ—Ä—Å–∏—è) */
    .field.revealed {
      background: var(--text);
      color: #111827;
    }
    .field.revealed .field-name { color: #111827; }
    .field.revealed .field-value { color: #111827; }
    .field .field-actions { margin-left: auto; display: inline-flex; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–µ–∫—Ü–∏—è */
    .cards-section { margin-top: 18px; }
    .cards-title { font-weight: 800; margin: 8px 0 10px; color: var(--text); }
    .card-item {
      margin-bottom: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .card-item .card-name { font-weight: 700; margin-bottom: 6px; }
    .card-cond { background: rgba(239,68,68,0.15); border-color: var(--red-dark); }
    .card-ev { background: rgba(16,185,129,0.15); border-color: var(--green-dark); }
    .card-item .reveal-btn { margin-left: 0; }
    .card-cond.revealed { background: rgba(239,68,68,0.35); border-color: var(--red); }
    .card-ev.revealed { background: rgba(16,185,129,0.35); border-color: var(--green); }

    @media (max-width: 768px) {
      body { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      header { position: sticky; top: 0; z-index: 10; }
      .player-card { padding-bottom: 110px; }
      .info-btn { display: inline-block; }
      .players-container {
        position: fixed;
        left: 0; right: 0; bottom: 0;
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
        border-top: 1px solid var(--border);
        border-bottom: none;
      }
    }

    /* –ú–æ–±–∏–ª—å–Ω–æ–µ –æ–≤–µ—Ä–ª–µ–π-–º–µ–Ω—é —Å –∏–Ω—Ñ–æ */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .sidebar-overlay.open { display: flex; }
    .sidebar-panel {
      width: min(92vw, 420px);
      max-height: 80vh;
      overflow: auto;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px var(--shadow);
    }
    .sidebar-panel .close-btn {
      background: var(--pink);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
    }
    .close-btn {
        background: var(--pink-hover) !important;
        color: white !important;
        border: none !important;
        padding: 12px !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: background 0.2s !important;
        text-align: center;
        flex: 1;
    }

    .close-btn:hover {
        background: var(--pink-hover) !important;
    }
    
    .admin-panel {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #ccc;
    }
    
    .admin-btn {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 5px;
      display: block;
      width: 100%;
    }

    .reveal-all-btn {
      background: var(--pink);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
    }

    .reveal-all-container {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border);
        }

    .reveal-all-btn:hover {
        background: var(--pink-hover);
    }
    .edit-form {
        display: flex;
        gap: 8px;
        width: 100%;
        margin-top: 8px;
    }

    .editable-field {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--panel-2);
        color: var(--text);
    }

    .submit-btn {
        background: var(--pink);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0 12px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .submit-btn:hover {
        background: var(--pink-hover);
    }
    .edit-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .values-display {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .old-value {
        text-decoration: line-through;
        color: var(--muted);
        opacity: 0.7;
    }

    .current-value {
        color: var(--text);
    }
    .field.revealed .current-value {
        color: #000; /* –ß—ë—Ä–Ω—ã–π —Ü–≤–µ—Ç */
    }
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .edit-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .edit-modal.open { display: flex; }
    .edit-panel {
      width: min(92vw, 500px);
      max-height: 80vh;
      overflow: auto;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px var(--shadow);
    }
    .edit-panel h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--pink);
    }
    .skill-edit-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    .skill-edit-item:last-child {
      border-bottom: none;
    }
    .edit-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .edit-form label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .edit-form input {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
    }
    .edit-form .submit-btn {
      background: var(--pink);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }
    .edit-form .submit-btn:hover {
      background: var(--pink-hover);
    }
    /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–∏ –∫–Ω–æ–ø–æ–∫ */
    .buttons-row {
        display: flex;
        gap: 10px;
        width: 100%;
    }

    .submit-btn, .close-btn {
        padding: 12px !important;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: background 0.2s;
    }

    /* —Ä–∞–∑–º–µ—Ä—ã –∫–Ω–æ–ø–æ–∫ 25% / 75% –≤ —Å—Ç—Ä–æ–∫–µ */
    .buttons-row .close-btn.small {
        flex: 0 0 25%;
        background: var(--pink-hover);
        color: white;
        border: none;
    }
    .buttons-row .submit-btn.large {
        flex: 0 0 75%;
        background: var(--pink);
        color: white;
        border: none;
    }

    .submit-btn:hover {
        background: var(--pink-hover);
    }

    .edit-form .close-btn {
        background: var(--pink-hover);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 10px;
    }

    .edit-form .close-btn:hover {
        background: var(--pink-hover);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã –Ω–∞–≤—ã–∫–æ–≤ */
    .skill-row {
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .skill-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
        font-size: 0.98em;
    }

    .skill-current {
        color: var(--muted);
        font-weight: 600;
    }

    .skill-new {
        display:flex;
        gap:8px;
        align-items: center;
    }

    .delta-wrap {
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:6px;
    }

    .delta-value {
    min-width:48px;
    font-weight:700;
    }

    .delta-bar { background:#2d3340; border-radius:6px; overflow:hidden; }
    .delta-bar-fill { height:100%; transition: width .25s ease, background-color .2s ease; }
    .delta-positive { background: linear-gradient(90deg, #10b981, #34d399); } /* –∑–µ–ª—ë–Ω—ã–π */
    .delta-negative { background: linear-gradient(90deg, #ef4444, #f97316); } /* –∫—Ä–∞—Å–Ω—ã–π/–æ—Ä–∞–Ω–∂–µ–≤—ã–π */


    .skill-note {
    font-size:0.85em;
    color:var(--muted);
    }

  </style>
</head>
<body>

<header>
  <div class="game-info">
    –í—ã: <strong>{{ current_player_name }}</strong> | 
    –ö–æ–¥ –∏–≥—Ä—ã: <strong>{{ code }}</strong>
  </div>
  <div style="display:flex; gap:8px; align-items:center;">
    <form method="get" action="{{ url_for('game') }}">
      <button type="submit" class="info-btn" style="background:var(--panel-2); border:1px solid var(--border);">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </form>
    <button class="info-btn" onclick="toggleSidebar()">–ò–Ω—Ñ–æ</button>
  </div>
</header>

<div class="players-container" id="playersContainer">
  {% if is_master %}
    <div class="player-badge admin" onclick="persistPlayersScroll(); location.href='{{ url_for('game') }}?reveal_all=1&keep_info=1&selected={{ selected }}'">
      <div class="player-number">‚òÖ</div>
      <div class="player-name">–û—Ç–∫—Ä—ã—Ç—å –≤—Å—ë</div>
    </div>
  {% endif %}
  {% for p in players %}
    <div class="player-badge {% if selected == loop.index0 %}selected{% endif %}"
         onclick="selectPlayer({{ loop.index0 }})">
      <div class="player-number">{{ loop.index }}</div>
      <div class="player-name">{{ p.name if p.name else '–ò–≥—Ä–æ–∫ ' ~ loop.index }}</div>
    </div>
  {% endfor %}
  <div class="player-badge exit" onclick="persistPlayersScroll(); location.href='{{ url_for('exit_game') }}'">
    <div class="player-number">‚á¶</div>
    <div class="player-name">–í—ã—Ö–æ–¥</div>
  </div>
</div>

<div class="player-card">
  {% set ns = namespace(conditions=None, actions=None, cond_revealed=False, act_revealed=False) %}
  {% for field in selected_player.fields %}
    {% if field.name in ['–£—Å–ª–æ–≤–∏—è', '–î–µ–π—Å—Ç–≤–∏—è'] %}
      {% if field.name == '–£—Å–ª–æ–≤–∏—è' %}{% set ns.conditions = field.value %}{% set ns.cond_revealed = field.revealed %}{% endif %}
      {% if field.name == '–î–µ–π—Å—Ç–≤–∏—è' %}{% set ns.actions = field.value %}{% set ns.act_revealed = field.revealed %}{% endif %}
    {% elif field.name == '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –Ω–∞–≤—ã–∫' %}
      <div class="field {% if field.revealed %}revealed{% endif %}">
        <div class="field-name">{{ field.name }}</div>
        <div class="field-value">
          {% if field.revealed or is_current_player %}
            {% if field.value %}
                <div class="skills-list" style="margin:0;padding:0;">
  {% set base_map = {} %}
  {% if 'base_value' in field %}
    {% for b in field.base_value %}
      {% set _ = base_map.update({ b['–Ω–∞–≤—ã–∫']: b['–æ—Ü–µ–Ω–∫–∞']|int }) %}
    {% endfor %}
  {% endif %}

  {% for item in field.value %}
    {% set skill = item['–Ω–∞–≤—ã–∫'] %}
    {% set score = item['–æ—Ü–µ–Ω–∫–∞']|int %}
    {% set base_score = base_map.get(skill, score) %}
    <div style="margin:0;padding:2px 0;">
      <div style="display:flex;justify-content:space-between;font-size:0.95em;">
        <span>{{ skill }}</span>
        <span>
          {{ score }}/10
          {% if score != base_score %}
            <div style="font-size:0.8em; color: {% if score > base_score %}#4caf50{% else %}#f44336{% endif %};">
              {% if score > base_score %}+{{ score - base_score }}{% else %}{{ score - base_score }}{% endif %}
            </div>
          {% endif %}
        </span>
      </div>
      <div style="height:8px;background:#2d3340;border-radius:6px;overflow:hidden;">
        <div style="height:100%;width:{{ (score/10*100)|round(0,'floor') }}%;background: var(--pink);"></div>
      </div>
    </div>
  {% endfor %}
</div>
            {% else %}
              –ù–µ —É–∫–∞–∑–∞–Ω–æ
            {% endif %}
            {% if is_current_player and not field.revealed %}
              <form action="{{ url_for('game') }}" method="GET" style="margin-left:auto;">
                <input type="hidden" name="reveal_field" value="{{ field.name }}">
                <input type="hidden" name="selected" value="{{ selected }}">
                <button type="submit" class="reveal-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÅÔ∏è</button>
              </form>
            {% endif %}

            {% if is_current_player or (is_master and field.revealed) %}
            <button
            class="open-skill-btn"
            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
            data-field-name='{{ field.name | tojson | replace("'", "&#x27;") }}'
            data-player='{{ selected }}'
            data-skills='{{ field.value | tojson | replace("'", "&#x27;") }}'
            >‚úèÔ∏è</button>
            {% endif %}
          {% else %}
            <em>–°–∫—Ä—ã—Ç–æ</em>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="field {% if field.revealed %}revealed{% endif %}">
        <div class="field-name">{{ field.name }}</div>
        <div class="field-value">
          {% if field.revealed %}
            <div class="values-display">
              {% if 'old_value' in field and field.old_value != field.value %}
                <span class="old-value">{{ field.old_value if field.old_value else "–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
              {% endif %}
              <span class="current-value">{{ field.value if field.value else "–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
            </div>
            
            {# –ü—Ä–∞–≤–∏–ª–æ –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: –≤–ª–∞–¥–µ–ª–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ –≤—Å–µ–≥–¥–∞; –º–∞—Å—Ç–µ—Ä ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π #}
            {% if is_current_player or (is_master and field.revealed) %}
            <button
            class="edit-toggle-btn open-edit-btn"
            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
            data-field-name='{{ field.name | tojson | replace("'", "&#x27;") }}'
            data-player='{{ selected }}'
            data-value='{{ field.value | tojson | replace("'", "&#x27;") }}'
            >‚úèÔ∏è</button>

            {% endif %}
          {% else %}
            {% if is_current_player %}
              <span>{{ field.value if field.value else "–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
              <span class="field-actions">
                <form action="{{ url_for('game') }}" method="GET">
                  <input type="hidden" name="reveal_field" value="{{ field.name }}">
                  <input type="hidden" name="selected" value="{{ selected }}">
                  <button type="submit" class="reveal-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÅÔ∏è</button>
                </form>
                {# –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª–µ —Å–∫—Ä—ã—Ç–æ #}
                <button
                class="edit-toggle-btn open-edit-btn"
                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                data-field-name='{{ field.name | tojson | replace("'", "&#x27;") }}'
                data-player='{{ selected }}'
                data-value='{{ field.value | tojson | replace("'", "&#x27;") }}'
                >‚úèÔ∏è</button>
              </span>
            {% else %}
              <em>–°–∫—Ä—ã—Ç–æ</em>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endfor %}

  <div class="cards-section">
    <div class="cards-title">–ö–∞—Ä—Ç–æ—á–∫–∏</div>
    <div class="card-item card-cond {% if ns.cond_revealed %}revealed{% endif %}">
      <div class="card-name">–£—Å–ª–æ–≤–∏—è</div>
      <div class="field-value">
        {% if ns.cond_revealed %}
          {{ ns.conditions if ns.conditions else '‚Äî' }}
        {% else %}
          {% if is_current_player %}
            {{ ns.conditions if ns.conditions else '‚Äî' }}
            <form action="{{ url_for('game') }}" method="GET">
              <input type="hidden" name="reveal_field" value="–£—Å–ª–æ–≤–∏—è">
              <input type="hidden" name="selected" value="{{ selected }}">
              <button type="submit" class="reveal-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÅÔ∏è</button>
            </form>
          {% else %}
            <em>–°–∫—Ä—ã—Ç–æ</em>
          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="card-item card-ev {% if ns.act_revealed %}revealed{% endif %}">
      <div class="card-name">–î–µ–π—Å—Ç–≤–∏—è</div>
      <div class="field-value">
        {% if ns.act_revealed %}
          {{ ns.actions if ns.actions else '‚Äî' }}
        {% else %}
          {% if is_current_player %}
            {{ ns.actions if ns.actions else '‚Äî' }}
            <form action="{{ url_for('game') }}" method="GET">
              <input type="hidden" name="reveal_field" value="–î–µ–π—Å—Ç–≤–∏—è">
              <input type="hidden" name="selected" value="{{ selected }}">
              <button type="submit" class="reveal-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÅÔ∏è</button>
            </form>
          {% else %}
            <em>–°–∫—Ä—ã—Ç–æ</em>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  {% if (is_master or is_current_player) and not all_revealed %}
    <div class="field-value">
      <form action="{{ url_for('reveal_all_player_fields') }}" method="GET" style="width: 100%;">
        <input type="hidden" name="player_index" value="{{ selected }}">
        <button type="submit" class="reveal-all-btn">
          {% if is_master and not is_current_player %}
          –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞
          {% else %}
          –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –º–æ–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
          {% endif %}
        </button>
      </form>
    </div>
  {% endif %}
</div>

<div class="sidebar">
  <h3>{{ bunker.A or bunker['A'] }}</h3>
  {% if bunker %}
  <div class="field-value">{{ bunker.B or bunker['B'] }}</div>
  <div class="field" style="margin-top:10px;">
      <div class="field-value" style="display:block;">
        <div class="field-row">
          <div class="field-name">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</div>
          <div class="field-value">{{ bunker.C or bunker['C'] }}</div>
        </div>
        {% set dval = bunker.D or bunker['D'] %}
        {% if dval %}
        <div class="field-row">
          <div class="field-name">–ü–æ–ª:</div>
          <div class="field-value">{{ dval }}</div>
        </div>
        {% endif %}
        <div class="field-row">
          <div class="field-name">–í—ã–∂–∏–≤—à–∏—Ö: </div>
          <div class="field-value">{{ survivors }} —á–µ–ª.</div>
        </div>
        {% if resources %}
          <div class="field-name">–†–µ—Å—É—Ä—Å—ã:</div>
          <div class="field-value">
            {% for res in resources %}
              {{ res }}{% if not loop.last %} <br> {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        {% if producers %}
          <div class="field-name">–í—ã–±–æ—Ä –ø—Ä–æ–¥—é—Å–µ—Ä–∞:</div>
          <div class="field-value">
            {% for prod in producers %}
              {{ prod }}{% if not loop.last %} <br> {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>
  </div>
  {% endif %}

  {% if random_event %}
    <div class="field {% if event_revealed %}revealed{% endif %}" style="margin-top:10px;">
      <div class="field-name">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
      <div class="field-value" style="display:flex; width:100%;">
        {% if event_revealed %}
          <span>{{ random_event }}</span>
        {% else %}
          <span><em>–°–∫—Ä—ã—Ç–æ</em></span>
          <form action="{{ url_for('game') }}" method="GET" style="margin-left:auto;">
            <input type="hidden" name="reveal_field" value="__random_event__">
            <button type="submit" class="reveal-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÅÔ∏è</button>
          </form>
        {% endif %}
      </div>
    </div>
  {% endif %}
  <p><strong>–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤:</strong> {{ players|length }}</p>
  <button onclick="location.href='{{ url_for('exit_game') }}'" 
          style="background: #ec4899; color: white; border: none; padding: 12px; border-radius: 10px; margin-top: 20px; width: 100%; font-weight:700;"
          onmouseover="this.style.background='#db2777'" onmouseout="this.style.background='#ec4899'">
    –í—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã
  </button>
</div>

<!-- –ú–æ–±–∏–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–≥—Ä–µ -->
<div id="sidebarOverlay" class="sidebar-overlay{% if open_info %} open{% endif %}" onclick="toggleSidebar()">
  <div class="sidebar-panel" onclick="event.stopPropagation()">
    <h3>{{ bunker.A or bunker['A'] }}</h3>
    {% if bunker %}
    <div class="field-value">{{ bunker.B or bunker['B'] }}</div>
      <div class="field" style="margin-top:10px;">
        <div class="field-value" style="display:block;">
          <div class="field-row">
            <div class="field-name">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</div>
            <div class="field-value">{{ bunker.C or bunker['C'] }}</div>
          </div>
          {% set dval = bunker.D or bunker['D'] %}
          {% if dval %}
          <div class="field-row">
            <div class="field-name">–ü–æ–ª:</div>
            <div class="field-value">{{ dval }}</div>
          </div>
          {% endif %}
          <div class="field-row">
            <div class="field-name">–í—ã–∂–∏–≤—à–∏—Ö: </div>
            <div class="field-value">{{ survivors }} —á–µ–ª.</div>
          </div>
        {% if resources %}
          <div class="field-name">–†–µ—Å—É—Ä—Å—ã:</div>
          <div class="field-value">
            {% for res in resources %}
              {{ res }}{% if not loop.last %} <br> {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        {% if producers %}
          <div class="field-name">–í—ã–±–æ—Ä –ø—Ä–æ–¥—é—Å–µ—Ä–∞:</div>
          <div class="field-value">
            {% for prod in producers %}
              {{ prod }}{% if not loop.last %} <br> {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        </div>
      </div>
    {% endif %}
    {% if random_event %}
      <div class="field {% if event_revealed %}revealed{% endif %}" style="margin-top:10px;">
        <div class="field-name">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
        <div class="field-value" style="display:flex; width:100%;">
          {% if event_revealed %}
            <span>{{ random_event }}</span>
          {% else %}
            <span><em>–°–∫—Ä—ã—Ç–æ</em></span>
            <form action="{{ url_for('game') }}" method="GET" style="margin-left:auto;">
              <input type="hidden" name="reveal_field" value="__random_event__">
              <button type="submit" class="reveal-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÅÔ∏è</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endif %}
    <p><strong>–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤:</strong> {{ players|length }}</p>
    <button class="close-btn" onclick="toggleSidebar()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª–µ–π -->
<div id="editModal" class="edit-modal">
  <div class="edit-panel" onclick="event.stopPropagation()">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: <span id="editFieldTitle"></span></h3>
    <form id="normalEditForm" action="{{ url_for('update_field') }}" method="POST">
      <input type="hidden" name="player_index" id="editPlayerIndex">
      <input type="hidden" name="field_name" id="editFieldName">
      
      <div class="edit-form">
        <label style="min-width:120px;margin:0;">–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
        <div id="currentFieldValue" style="padding: 10px; background: var(--panel-2); border-radius: 6px; min-width: 120px;"></div>
        
        <label for="newFieldValue" style="min-width:120px;margin:0;">–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
        <input type="text" id="newFieldValue" name="new_value" class="editable-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ">
      </div>

      <div class="buttons-row" style="margin-top:12px;">
          <!-- –ü–æ–º–µ–Ω—è–ª–∏ –º–µ—Å—Ç–∞–º–∏: —Å–Ω–∞—á–∞–ª–∞ –ó–∞–∫—Ä—ã—Ç—å 25%, –∑–∞—Ç–µ–º –°–æ—Ö—Ä–∞–Ω–∏—Ç—å 75% -->
          <button class="close-btn small" onclick="closeEditModal(); return false;">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button type="submit" class="submit-btn large">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤ -->
<div id="skillEditModal" class="edit-modal">
  <div class="edit-panel" onclick="event.stopPropagation()">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤</h3>
    <form id="skillsEditForm" action="{{ url_for('update_field') }}" method="POST">
      <!-- –û–¥–Ω–∞ —Å–∫—Ä—ã—Ç–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è player_index (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ JS) -->
      <input type="hidden" name="player_index" id="editSkillsPlayerIndex" value="">
      
      <div id="skillsFieldsContainer" style="margin-bottom: 20px;">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–ª—è –¥–ª—è –Ω–∞–≤—ã–∫–æ–≤ —á–µ—Ä–µ–∑ JS -->
      </div>
      
    <div class="buttons-row">
        <!-- –ø–æ–º–µ–Ω—è–ª–∏ –º–µ—Å—Ç–∞–º–∏: Close (25%) —Å–ª–µ–≤–∞, Save (75%) —Å–ø—Ä–∞–≤–∞ -->
        <button type="button" class="close-btn small" onclick="closeSkillEditModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button type="submit" class="submit-btn large">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    </form>
  </div>
</div>

<script>
  function toggleSidebar(){
    var el = document.getElementById('sidebarOverlay');
    if (!el) return;
    
    el.classList.toggle('open');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º URL –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–∞–Ω–µ–ª–∏
    var url = new URL(window.location.href);
    if (el.classList.contains('open')) {
      url.searchParams.set('keep_info', '1');
    } else {
      url.searchParams.delete('keep_info');
    }
    history.replaceState(null, '', url.toString());
  }

  function persistPlayersScroll(){
    var c = document.getElementById('playersContainer');
    if(!c) return;
    try { sessionStorage.setItem('playersScroll_' + '{{ code }}', String(c.scrollLeft)); } catch(e) {}
  }

  function restorePlayersScroll(){
    var c = document.getElementById('playersContainer');
    if(!c) return;
    try {
      var v = sessionStorage.getItem('playersScroll_' + '{{ code }}');
      if(v !== null){ c.scrollLeft = parseInt(v, 10) || 0; }
    } catch(e) {}
  }

  function selectPlayer(idx){
    persistPlayersScroll();
    var url = new URL(window.location.href);
    url.searchParams.set('selected', String(idx));
    
    // –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º `keep_info=1`
    var sidebarOverlay = document.getElementById('sidebarOverlay');
    if (sidebarOverlay && sidebarOverlay.classList.contains('open')) {
      url.searchParams.set('keep_info', '1');
    } else {
      url.searchParams.delete('keep_info');
    }
    
    window.location.href = url.toString();
  }

  function toggleEditForm(button) {
    const fieldContainer = button.closest('.field-value');
    const editForm = fieldContainer.querySelector('.edit-form');
    const valuesDisplay = fieldContainer.querySelector('.values-display');
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
    if (editForm.style.display === 'none') {
      editForm.style.display = 'flex';
      button.textContent = '–û—Ç–º–µ–Ω–∞';
    } else {
      editForm.style.display = 'none';
      button.textContent = '‚úèÔ∏è';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    restorePlayersScroll();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.querySelectorAll('.current-value').forEach(el => {
      el.addEventListener('click', function() {
        const fieldContainer = this.closest('.field-value');
        const editBtn = fieldContainer.querySelector('.edit-toggle-btn');
        if (editBtn) {
          editBtn.click();
        }
      });
    });
  });

  function openEditModal(fieldName, playerIndex, currentValue) {
    const modal = document.getElementById('editModal');
    modal.classList.add('open');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    document.getElementById('editFieldTitle').textContent = String(fieldName);
    document.getElementById('editPlayerIndex').value = String(playerIndex);
    document.getElementById('editFieldName').value = String(fieldName);
    // currentValue –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å—Ç—Ä–æ–∫–æ–π ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Ç–∞–µ–º—É—é —Ñ–æ—Ä–º—É
    try {
      if (currentValue === null || currentValue === undefined) {
        document.getElementById('currentFieldValue').textContent = '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        document.getElementById('newFieldValue').value = '';
      } else if (typeof currentValue === 'object') {
        document.getElementById('currentFieldValue').textContent = JSON.stringify(currentValue);
        document.getElementById('newFieldValue').value = '';
      } else {
        document.getElementById('currentFieldValue').textContent = String(currentValue);
        document.getElementById('newFieldValue').value = String(currentValue);
      }
    } catch (e) {
      document.getElementById('currentFieldValue').textContent = String(currentValue);
      document.getElementById('newFieldValue').value = String(currentValue || '');
    }
  }

function openSkillEditModal(fieldName, playerIndex, skills) {
  try {
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Ö–æ–¥ (skills –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π JSON –∏–ª–∏ —É–∂–µ –º–∞—Å—Å–∏–≤–æ–º)
    if (typeof skills === 'string') {
      const s = skills.trim();
      if (s === '') skills = [];
      else {
        try { skills = JSON.parse(s); }
        catch (err) { console.warn('openSkillEditModal: failed parse skills, using []', err); skills = []; }
      }
    }
    if (!Array.isArray(skills)) skills = [];

    const modal = document.getElementById('skillEditModal');
    if (!modal) return;
    modal.classList.add('open');

    const container = document.getElementById('skillsFieldsContainer');
    container.innerHTML = ''; // –æ—á–∏—Å—Ç–∏–º

    // –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ field_name
    container.insertAdjacentHTML('beforeend', `<input type="hidden" name="field_name" value="${String(fieldName).replace(/"/g,'&quot;')}">`);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π —Å–∫—Ä—ã—Ç—ã–π player_index
    const topPlayerInput = document.getElementById('editSkillsPlayerIndex');
    if (topPlayerInput) topPlayerInput.value = String(playerIndex);

    // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–≤—ã–∫–∏ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
    skills.forEach((skill, index) => {
      const sName = skill && skill['–Ω–∞–≤—ã–∫'] ? String(skill['–Ω–∞–≤—ã–∫']) : '';
      const sScore = (skill && (skill['–æ—Ü–µ–Ω–∫–∞'] !== undefined && skill['–æ—Ü–µ–Ω–∫–∞'] !== null)) ? Number(skill['–æ—Ü–µ–Ω–∫–∞']) : 0;

      const safeName = sName.replace(/"/g, '&quot;');
      const skillHtml = `
        <div class="skill-row" data-index="${index}" data-original="${sScore}">
          <div class="skill-top">
            <div class="skill-title">${safeName}</div>
            <div class="skill-current">–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞: <strong>${sScore}</strong>/10</div>
          </div>

          <div class="skill-new">
            <label style="min-width:120px;margin:0;">–ù–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:</label>
            <input type="number" class="skill-input" name="skills[${index}][–æ—Ü–µ–Ω–∫–∞]" min="0" max="10" step="1" value="${sScore}" style="width:92px; padding:8px; border-radius:6px; border:1px solid var(--border); background:var(--panel-2); color:var(--text);">
            <!-- –∑–∞—â–∏—â—ë–Ω–Ω–æ–µ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º –Ω–∞–≤—ã–∫–∞ -->
            <input type="hidden" name="skills[${index}][–Ω–∞–≤—ã–∫]" value="${safeName}">
          </div>

          <div class="delta-wrap">
            <div class="delta-value">Œî <span class="delta-number">0</span></div>
            <div class="delta-bar"><div class="delta-bar-fill delta-neutral" style="width:0%;"></div></div>
          </div>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', skillHtml);
    });

    // –ï—Å–ª–∏ –Ω–∞–≤—ã–∫–æ–≤ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É (–∫–∞–∫ –¥–æ —ç—Ç–æ–≥–æ)
    if (skills.length === 0) {
      container.insertAdjacentHTML('beforeend', `
        <div class="skill-row" data-index="0" data-original="0">
          <div class="skill-top"><div class="skill-title">(–ù–æ–≤—ã–π –Ω–∞–≤—ã–∫)</div><div class="skill-current">–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞: <strong>0</strong>/10</div></div>
          <div class="skill-new">
            <label style="min-width:120px;margin:0;">–ù–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:</label>
            <input type="number" class="skill-input" name="skills[0][–æ—Ü–µ–Ω–∫–∞]" min="0" max="10" step="1" value="0" style="width:92px; padding:8px; border-radius:6px; border:1px solid var(--border); background:var(--panel-2); color:var(--text);">
            <input type="hidden" name="skills[0][–Ω–∞–≤—ã–∫]" value="">
          </div>
          <div class="delta-wrap">
            <div class="delta-value">Œî <span class="delta-number">0</span></div>
            <div class="delta-bar"><div class="delta-bar-fill delta-neutral" style="width:0%;"></div></div>
          </div>
        </div>
      `);
    }

    // –ù–∞–≤–µ—Å–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ input-—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–µ–ª—å—Ç—ã –∏ –ø–æ–ª–æ—Å–∫–∏
    container.querySelectorAll('.skill-input').forEach(input => {
      input.addEventListener('input', function() {
        const row = this.closest('.skill-row');
        if (!row) return;
        const original = Number(row.dataset.original || 0);
        let newVal = Number(this.value);
        if (Number.isNaN(newVal)) newVal = 0;
        // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 0..10
        if (newVal < 0) newVal = 0;
        if (newVal > 10) newVal = 10;
        this.value = Math.round(newVal);

        const delta = newVal - original;
        const deltaNumberEl = row.querySelector('.delta-number');
        const barFill = row.querySelector('.delta-bar-fill');

        deltaNumberEl.textContent = (delta > 0 ? '+' + delta : delta);

        // –ø—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è –ø–æ–ª–æ—Å–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—É—é —Ä–∞–∑–Ω–∏—Ü—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 0..10
        const pct = Math.min(100, Math.abs(delta) / 10 * 100);
        barFill.style.width = pct + '%';

        // —Ü–≤–µ—Ç
        barFill.classList.remove('delta-positive', 'delta-negative', 'delta-neutral');
        if (delta > 0) barFill.classList.add('delta-positive');
        else if (delta < 0) barFill.classList.add('delta-negative');
        else barFill.classList.add('delta-neutral');
      });

      // –¢—Ä–∏–≥–≥–µ—Ä–∏–º initial update, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å –Ω—É–ª–µ–≤—ã–µ –¥–µ–ª—å—Ç—ã
      input.dispatchEvent(new Event('input'));
    });

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≤—ã–∫–æ–≤ (—Å–º. –∫–æ–Ω—Å–æ–ª—å).');
  }
}


function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  document.getElementById('normalEditForm').reset();
  // –æ—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
  document.getElementById('currentFieldValue').textContent = '';
}

function closeSkillEditModal() {
  document.getElementById('skillEditModal').classList.remove('open');
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  document.getElementById('skillsEditForm').reset();
  // –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  document.getElementById('skillsFieldsContainer').innerHTML = '';
  // –æ—á–∏—Å—Ç–∏–º –≤–µ—Ä—Ö–Ω–∏–π player_index
  const topPlayerInput = document.getElementById('editSkillsPlayerIndex');
  if (topPlayerInput) topPlayerInput.value = '';
}

async function submitForm(formElement, closeFunction) {
    try {
        let body;
        let contentType;
        
        // –î–ª—è —Ñ–æ—Ä–º—ã –Ω–∞–≤—ã–∫–æ–≤ —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é
        if (formElement.id === 'skillsEditForm') {
            const skills = [];
            formElement.querySelectorAll('.skill-row').forEach(row => {
                const skillInput = row.querySelector('input[name$="[–Ω–∞–≤—ã–∫]"]');
                const scoreInput = row.querySelector('input[name$="[–æ—Ü–µ–Ω–∫–∞]"]');
                if (skillInput && scoreInput) {
                    skills.push({
                        "–Ω–∞–≤—ã–∫": skillInput.value,
                        "–æ—Ü–µ–Ω–∫–∞": Number(scoreInput.value)
                    });
                }
            });
            
            body = new URLSearchParams();
            body.append('player_index', document.getElementById('editSkillsPlayerIndex').value);
            body.append('field_name', document.querySelector('#skillsEditForm input[name="field_name"]').value);
            body.append('new_value', JSON.stringify(skills));
            contentType = 'application/x-www-form-urlencoded';
        } 
        // –î–ª—è –æ–±—ã—á–Ω–æ–π —Ñ–æ—Ä–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        else {
            body = new FormData(formElement);
        }

        const headers = {};
        if (contentType) {
            headers['Content-Type'] = contentType;
        }

        const response = await fetch(formElement.action, {
            method: 'POST',
            body: body,
            credentials: 'same-origin',
            headers: headers
        });

        const text = await response.text();
        if (response.ok) {
            closeFunction();
            window.location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + text);
        }
    } catch (error) {
        alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + error);
    }
}


// –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.addEventListener('DOMContentLoaded', function() {
    // –î–ª—è –æ–±—ã—á–Ω–æ–π —Ñ–æ—Ä–º—ã
    const normalForm = document.getElementById('normalEditForm');
    if (normalForm) {
      normalForm.addEventListener('submit', function(e) {
          e.preventDefault();
          submitForm(this, closeEditModal);
      });
    }
    
    // –î–ª—è —Ñ–æ—Ä–º—ã –Ω–∞–≤—ã–∫–æ–≤
    const skillsForm = document.getElementById('skillsEditForm');
    if (skillsForm) {
      skillsForm.addEventListener('submit', function(e) {
          e.preventDefault();
          submitForm(this, closeSkillEditModal);
      });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeEditModal();
            closeSkillEditModal();
        }
    });
});

function persistCardScroll() {
  const card = document.querySelector('.player-card');
  if (card) {
    sessionStorage.setItem('cardScroll_{{ code }}', card.scrollTop);
  }
}

function restoreCardScroll() {
  const card = document.querySelector('.player-card');
  if (card) {
    const saved = sessionStorage.getItem('cardScroll_{{ code }}');
    if (saved !== null) {
      card.scrollTop = parseInt(saved);
      sessionStorage.removeItem('cardScroll_{{ code }}');
    }
  }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
document.querySelectorAll('.reveal-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    persistCardScroll();
    persistPlayersScroll();
  });
});

// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
  restorePlayersScroll();
  restoreCardScroll();
});

document.addEventListener('DOMContentLoaded', () => {

  function safeParsePossibleJSON(raw) {
    if (raw === undefined || raw === null) return null;
    const s = String(raw).trim();
    if (s === '') return null;
    // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ JSON (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å { [ –∏–ª–∏ " ), –ø–æ–ø—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å
    if (/^[\{\[\"]/.test(s)) {
      try {
        return JSON.parse(s);
      } catch (err) {
        // –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ —É–ø–∞–ª ‚Äî –≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        console.warn('safeParsePossibleJSON: parse failed, return raw', err, raw);
        return raw;
      }
    }
    return raw;
  }

  // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤
  document.body.addEventListener('click', (ev) => {
    const skillBtn = ev.target.closest('.open-skill-btn');
    if (skillBtn) {
      ev.preventDefault();
      // —á–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
      const rawName = skillBtn.dataset.fieldName;
      const playerIndex = Number(skillBtn.dataset.player);
      const rawSkills = skillBtn.dataset.skills; // —Å—Ç—Ä–æ–∫–∞ (JSON) –∏–ª–∏ –ø—É—Å—Ç–æ
      // –ø–µ—Ä–µ–¥–∞—ë–º –≤ –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é: –æ–Ω–∞ —É–º–µ–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ —Å—Ç—Ä–æ–∫—É, –∏ –º–∞—Å—Å–∏–≤
      try {
        // fieldName –º–æ–∂–µ—Ç –±—ã—Ç—å JSON-—Å—Ç—Ä–æ–∫–æ–π (–≤ –∫–∞–≤—ã—á–∫–∞—Ö) ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏–º
        let fieldName = safeParsePossibleJSON(rawName);
        if (typeof fieldName === 'string' && fieldName.startsWith('"') && fieldName.endsWith('"')) {
          try { fieldName = JSON.parse(fieldName); } catch(e) {}
        }
        openSkillEditModal(fieldName, playerIndex, rawSkills);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤:', err);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤ ‚Äî —Å–º. –∫–æ–Ω—Å–æ–ª—å.');
      }
      return;
    }

    // –û–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const editBtn = ev.target.closest('.open-edit-btn');
    if (editBtn) {
      ev.preventDefault();
      const rawName = editBtn.dataset.fieldName;
      const playerIndex = Number(editBtn.dataset.player);
      const rawValue = editBtn.dataset.value;
      try {
        let fieldName = safeParsePossibleJSON(rawName);
        if (typeof fieldName === 'string' && fieldName.startsWith('"') && fieldName.endsWith('"')) {
          try { fieldName = JSON.parse(fieldName); } catch(e) {}
        }
        const parsedValue = safeParsePossibleJSON(rawValue);
        openEditModal(fieldName, playerIndex, parsedValue);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø–æ–ª—è:', err);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø–æ–ª—è ‚Äî —Å–º. –∫–æ–Ω—Å–æ–ª—å.');
      }
      return;
    }
  });
});

</script>

</body>
</html>
